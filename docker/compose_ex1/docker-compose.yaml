services:
  nifi:
    image: apache/nifi:latest # or pin e.g. apache/nifi:2.0.0-Mx if needed
    container_name: nifi
    restart: unless-stopped

    ports:
      - "${NIFI_HTTPS_PORT}:8443" # host:container — both use the same value via var

    environment:
      # Force HTTPS listening on all interfaces (required for external access)
      - NIFI_WEB_HTTPS_HOST=0.0.0.0
      - NIFI_WEB_HTTPS_PORT=${NIFI_HTTPS_PORT}

      # Disable HTTP completely (recommended with HTTPS)
      - NIFI_WEB_HTTP_PORT=

      # Pull from .env file
      - SINGLE_USER_CREDENTIALS_USERNAME=${SINGLE_USER_CREDENTIALS_USERNAME}
      - SINGLE_USER_CREDENTIALS_PASSWORD=${SINGLE_USER_CREDENTIALS_PASSWORD}

      # Optional: enable Python processors support
      - NIFI_PYTHON_COMMAND=python3
      - NIFI_PYTHON_MAX_PROCESSES=50

    volumes:
      # Core persistence (state is most important)
      #- nifi-data:/opt/nifi/nifi-current/state
      - type: bind
        source: ./nifi-data
        target: /opt/nifi/nifi-current/state

      # Optional — only mount if you need to customize nifi.properties or other conf
      # - ./nifi-conf:/opt/nifi/nifi-current/conf:ro

      # Logs (useful for debugging without docker logs)
      # Named volume
      #- nifi-logs:/opt/nifi/nifi-current/logs
      # Bind mount
      - type: bind
        source: ./nifi-logs
        target: /opt/nifi/nifi-current/logs

      # Extensions / custom processors (optional)
      - nifi-extensions:/opt/nifi/nifi-current/lib
      # - type: bind
      #   source: ./nifi-extensions
      #   target: /opt/nifi/nifi-current/lib

    healthcheck:
      test:
        [
          "CMD",
          "curl",
          "-f",
          "-k",
          "https://localhost:${NIFI_HTTPS_PORT}/nifi-api/system-diagnostics",
        ]
      interval: 10s
      timeout: 5s
      retries: 15
      start_period: 60s # Give NiFi time to generate certs & start Jetty

volumes:
  nifi-data:
  nifi-logs:
  # nifi-conf:   # uncomment only if you're overriding conf files
  nifi-extensions:
# volumes:
#   nifi-data:
#     driver: local
#   nifi-logs:
#     driver: local
#   nifi-extensions:
#     driver: local

# volumes:
#   - ./nifi-extensions:/opt/nifi/nifi-current/lib
